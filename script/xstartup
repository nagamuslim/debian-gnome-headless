
[ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
test x"$SHELL" = x"" && SHELL=/bin/bash
test x"$1" = x"" && set -- default
xhost +
sudo -u debian -i bash -x >>/home/debian/xstartup.log 2>&1 <<'EOF'
#sudo -u debian -i bash <<'EOF'
export DISPLAY=:1
export XAUTHORITY=/home/debian/.Xauthority

detect_butt() {
    # Wait until AppImage appears (system is fully initialized)
    while ! find /usr/local/bin -maxdepth 1 -name 'butt*.AppImage' -print -quit | grep -q .; do
        sleep 5
    done
}

detect_gnome() {
    local timeout=0
    local max_wait=30 # Total wait time is max_wait * sleep_interval (30 * 2s = 60s)

    echo "Waiting for GNOME Shell and Settings Daemon..."

    # Loop until both processes are found or the timeout is reached
    while ! (pgrep -x gnome-shell >/dev/null && pgrep -x gsd-color >/dev/null); do
        if [ $timeout -ge $max_wait ]; then
            echo "Error: Timed out waiting for GNOME services to start." >&2
            return 1
        fi
        sleep 2
        timeout=$((timeout + 1))
    done

    echo "GNOME services are running. Checking color scheme..."

    # Check the current color scheme and set it to dark if it isn't already
    if [[ "$(gsettings get org.gnome.desktop.interface color-scheme)" != *'prefer-dark'* ]]; then
        echo "Setting color scheme to 'prefer-dark'."
        gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
    else
        echo "Dark mode is already enabled."
    fi

    return 0
}

( detect_butt && detect_gnome && echo "Background task started successfully at $(date)" >> /tmp/background_task1.log && vncconfig -iconic & ) &

gsettings set org.gnome.shell favorite-apps "['firefox.desktop', 'org.gnome.Evolution.desktop', 'org.gnome.Nautilus.desktop', 'org.kde.discover.desktop', 'xfce4-terminal.desktop', 'org.gnome.TextEditor.desktop', 'org.gnome.Calculator.desktop']"
gsettings set org.gnome.desktop.session idle-delay 0
gsettings set org.gnome.desktop.screensaver lock-enabled false
gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
gsettings get org.gnome.desktop.interface color-scheme | grep -q 'prefer-dark' || gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
gsettings set org.gnome.desktop.background show-desktop-icons true
gnome-extensions enable ding@rastersoft.com

( detect_butt && detect_gnome && echo "Background task started successfully at $(date)" >> /tmp/background_task2.log && butt -c /home/debian/butt.txt >/dev/null 2>&1 & ) &


( while true; do if [ -f "$HOME/.local/share/keyrings/default" ] || [ -f "$HOME/.local/share/keyrings/Default_keyring.keyring" ]; then break; fi; for f in "$HOME"/.local/share/keyrings/*login*.keyring; do [ -f "$f" ] && rm "$f"; done; sleep 10; done) & disown
( mkdir -p "$HOME/Desktop"; for f in firefox.desktop org.gnome.Console.desktop xfce4-terminal.desktop org.kde.discover.desktop com.github.tchx84.Flatseal.desktop org.gnome.seahorse.Application.desktop org.gnome.tweaks.desktop com.mattjakeman.ExtensionManager.desktop; do dest="$HOME/Desktop/$f"; src="/usr/share/applications/$f"; [ ! -f "$dest" ] && [ -f "$src" ] && cp "$src" "$dest"; done; chmod +x "$HOME/Desktop"/*.desktop 2>/dev/null ) & disown
( detect_butt && detect_gnome && sleep 10 && echo "Background task started successfully at $(date)" >> /tmp/background_task3.log && /usr/local/bin/butt*.AppImage -c /home/debian/buttweb.txt & ) &
( ( C=$(cat /tmp/gatekeep.count 2>/dev/null || echo 0); (( C < 2 )) && echo $((C+1)) > /tmp/gatekeep.count || exit 1 ) && detect_butt && sleep 10 && sudo rm -rf /home/debian/.config/gnome-initial-setup-done && sleep 5 && ( while true; do pgrep -x gnome-initial-setup >/dev/null || gnome-initial-setup; sleep 5; done ) & ) &
( current_lang=$(localectl status | grep 'System Locale' | cut -d'=' -f2); while sleep 10; do new_lang=$(localectl status | grep 'System Locale' | cut -d'=' -f2); sys_lang=$(cat /etc/default/locale 2>/dev/null | grep LANG= | cut -d'=' -f2 | tr -d '"'); [ "$current_lang" != "$new_lang" ] || [ "$current_lang" != "$sys_lang" ] && echo "export DEFAULT_LANG='$new_lang'" | sudo tee /etc/profile.d/00docker-env.sh > /dev/null && killall gnome-session vnc && exit; current_lang="$new_lang"; done ) &

export XDG_SESSION_TYPE=x11
mkdir -p /home/debian/.vnc && pgrep vncserver > /home/debian/.vnc/$(hostname):1.pid
lang_val=$(grep '^export DEFAULT_LANG=' /etc/profile.d/00docker-env.sh 2>/dev/null | cut -d"'" -f2); [ -n "$lang_val" ] && export LANG="$lang_val"
exec gnome-session

EOF

vncserver -kill $DISPLAY
