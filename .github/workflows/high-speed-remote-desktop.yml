name: High-Speed Remote Desktop

on:
  workflow_dispatch:
    inputs:
      screen_res:
        description: 'Screen Resolution'
        required: true
        default: '1280x720'
        type: choice
        options:
          - '1280x720'
          - '1920x1080'
          - '1600x900'
          - '1024x768'
      connection_mode:
        description: 'Connection Mode'
        required: true
        default: 'VNC (HTTP)'
        type: choice
        options:
          - 'VNC (HTTP)'
          - 'SSH (TCP)'

jobs:
  run-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM nagamuslim/debian-gnome-headless:latest

          # 1. Update butt version to 1.46.0 in installer.env
          RUN sed -i 's|butt-1.45.0-x86_64.AppImage|butt-1.46.0-x86_64.AppImage|g' /etc/installer.env && \
              sed -i 's|/release/1.45.0/|/release/1.46.0/|g' /etc/installer.env

          # 2. Patch noVNC HTML for Icecast Audio Plugin
          RUN sed -i '/novnc-mediamtx-audio.js/d' /usr/share/novnc/vnc.html && \
              sed -i 's|<\/head>|<script src="https://cdn.jsdelivr.net/npm/novnc-audio-plugin/novnc-icecast-audio.js" data-stream-path="/stream-fallback" defer></script><\/head>|g' /usr/share/novnc/vnc.html
          EOF

      - name: Build Custom Image
        run: docker build -t my-custom-desktop .

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com/ buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok jq
          
          if [[ "${{ github.event.inputs.connection_mode }}" == "SSH (TCP)" ]]; then
            echo "Starting TCP Tunnel for SSH..."
            nohup ngrok tcp 2022 --log=stdout > ngrok.log 2>&1 &
          else
            echo "Starting HTTP Tunnel for VNC..."
            nohup ngrok http 6901 --log=stdout > ngrok.log 2>&1 &
          fi
          
          sleep 5

      - name: Start GNOME Headless
        run: |
          docker run -d \
            --name gnome-desktop \
            --privileged \
            -p 6901:6901 \
            -p 2022:22 \
            -e gnome-initial-setup=no \
            -e DEFAULT_TZ=Asia/Jakarta \
            -e res=${{ github.event.inputs.screen_res }} \
            my-custom-desktop

      - name: Get Connection URL
        run: |
          echo "========================================================="
          echo "   CONNECTION DETAILS   "
          echo "========================================================="
          PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          if [[ $PUBLIC_URL == tcp://* ]]; then
            SSH_HOST=$(echo $PUBLIC_URL | sed 's|tcp://||')
            echo "MODE: SSH (TCP)"
            echo "Host: ${SSH_HOST%:*}, Port: ${SSH_HOST##*:}"
            echo "Command: ssh debian@${SSH_HOST%:*} -p ${SSH_HOST##*:}"
          else
            echo "MODE: VNC (HTTP)"
            echo "URL: $PUBLIC_URL"
          fi
          echo "Password: debian"
          echo "========================================================="

      - name: Wait for User Shutdown
        run: |
          echo "Container is running. Manual stop required via 'kill 1' or GitHub stop."
          docker wait gnome-desktop

      - name: Cleanup
        if: always()
        run: docker rm -f gnome-desktop
