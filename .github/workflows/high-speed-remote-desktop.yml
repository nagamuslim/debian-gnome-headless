name: High-Speed Remote Desktop

on:
  workflow_dispatch:
    inputs:
      screen_res:
        description: 'Screen Resolution'
        required: true
        default: '1280x720'
        type: choice
        options:
          - '1280x720'
          - '1920x1080'
          - '1600x900'
          - '1024x768'
      connection_mode:
        description: 'Connection Mode'
        required: true
        default: 'VNC (HTTP)'
        type: choice
        options:
          - 'VNC (HTTP)'
          - 'SSH (TCP)'

# 1. PERMISSIONS REQUIRED TO COMMIT CHANGES
permissions:
  contents: write

jobs:
  run-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM nagamuslim/debian-gnome-headless:latest
          # 1. Update butt version to 1.46.0 in installer.env
          RUN sed -i 's|butt-1.45.0-x86_64.AppImage|butt-1.46.0-x86_64.AppImage|g' /etc/installer.env && \
              sed -i 's|/release/1.45.0/|/release/1.46.0/|g' /etc/installer.env
          # 2. Patch noVNC HTML for Icecast Audio Plugin
          RUN sed -i 's|<\/head>|<script src="https://cdn.jsdelivr.net/npm/novnc-audio-plugin/novnc-icecast-audio.js" data-stream-path="/stream-fallback" defer></script><\/head>|g' /usr/share/novnc/vnc.html
          EOF

      - name: Build Custom Image
        run: docker build -t my-custom-desktop .

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com/ buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok jq
          
          if [[ "${{ github.event.inputs.connection_mode }}" == "SSH (TCP)" ]]; then
            echo "Starting TCP Tunnel for SSH..."
            nohup ngrok tcp 2022 --log=stdout > ngrok.log 2>&1 &
          else
            echo "Starting HTTP Tunnel for VNC..."
            nohup ngrok http 6901 --log=stdout > ngrok.log 2>&1 &
          fi
          
          sleep 10

      - name: Start GNOME Headless
        run: |
          docker run -d \
            --name gnome-desktop \
            --privileged \
            -p 6901:6901 \
            -p 2022:22 \
            -e gnome-initial-setup=no \
            -e DEFAULT_TZ=Asia/Jakarta \
            -e res=${{ github.event.inputs.screen_res }} \
            my-custom-desktop

      - name: Get Connection URL
        id: get_url
        run: |
          PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          # Handle SSH format vs HTTP format for display
          if [[ $PUBLIC_URL == tcp://* ]]; then
            # Convert tcp://0.tcp.ngrok.io:12345 to proper SSH display string if needed, 
            # but for the HTML button, we might just want the raw link or instructions.
            # For VNC it's a clickable URL. For SSH, we can't really make a browser link easily.
            # Assuming VNC mostly based on HTML request:
            FINAL_URL="$PUBLIC_URL"
          else
            FINAL_URL="$PUBLIC_URL/vnc.html?password=debian&autoconnect=true"
          fi
          
          echo "url=$FINAL_URL" >> $GITHUB_OUTPUT
          echo "raw_url=$PUBLIC_URL" >> $GITHUB_OUTPUT

      # 2. UPDATE HTML TO ONLINE STATE
      - name: Update Website Status (Online)
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          TARGET_FILE="project/desktop/index.html"
          URL="${{ steps.get_url.outputs.url }}"
          
          # Pull latest to avoid conflicts
          git pull
          
          # 1. Update Status Text to ONLINE (Green)
          sed -i 's|<!-- MAGIC_STATUS_START -->.*<!-- MAGIC_STATUS_END -->|<!-- MAGIC_STATUS_START --><p class="text-xl font-bold text-green-500 animate-pulse">ONLINE</p><!-- MAGIC_STATUS_END -->|g' $TARGET_FILE
          
          # 2. Update HREF and style to Active (Blue button, clickable)
          sed -i "s|<!-- MAGIC_HREF_START -->.*<!-- MAGIC_HREF_END -->|<!-- MAGIC_HREF_START --><a href=\"$URL\" target=\"_blank\" class=\"w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200\"><!-- MAGIC_HREF_END -->|g" $TARGET_FILE
          
          git add $TARGET_FILE
          git commit -m "Update desktop status: ONLINE"
          git push

      - name: Wait for User Shutdown
        run: |
          echo "Container is running. Connect here: ${{ steps.get_url.outputs.url }}"
          docker wait gnome-desktop

      # 3. RESET HTML TO OFFLINE STATE (Runs even if job is cancelled)
      - name: Reset Website Status (Offline)
        if: always() 
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          TARGET_FILE="project/desktop/index.html"
          
          # Pull latest
          git pull
          
          # 1. Revert Status to OFFLINE (Red)
          sed -i 's|<!-- MAGIC_STATUS_START -->.*<!-- MAGIC_STATUS_END -->|<!-- MAGIC_STATUS_START --><p class="text-xl font-bold text-red-500">OFFLINE</p><!-- MAGIC_STATUS_END -->|g' $TARGET_FILE
          
          # 2. Revert HREF to # and style to Disabled (Gray)
          sed -i 's|<!-- MAGIC_HREF_START -->.*<!-- MAGIC_HREF_END -->|<!-- MAGIC_HREF_START --><a href="#" target="_blank" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 cursor-not-allowed pointer-events-none transition-colors duration-200"><!-- MAGIC_HREF_END -->|g' $TARGET_FILE
          
          git add $TARGET_FILE
          git commit -m "Update desktop status: OFFLINE"
          git push

      - name: Cleanup Container
        if: always()
        run: docker rm -f gnome-desktop