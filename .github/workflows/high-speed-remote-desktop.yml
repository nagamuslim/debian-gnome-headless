name: High-Speed Remote Desktop

on:
  workflow_dispatch:
    inputs:
      screen_res:
        description: 'Screen Resolution'
        required: true
        default: '1280x720'
        type: choice
        options:
          - '1280x720'
          - '1920x1080'
          - '1600x900'
          - '1024x768'

jobs:
  run-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM nagamuslim/debian-gnome-headless:latest

          # 1. Update ONLY the butt AppImage in /etc/installer.env via sed, preserving other entries
          RUN if grep -q "butt.*AppImage" /etc/installer.env; then \
                sed -i "s|https://danielnoethen.de/butt/release/.*butt-.*-x86_64.AppImage|https://danielnoethen.de/butt/release/1.46.0/butt-1.46.0-x86_64.AppImage|g" /etc/installer.env; \
              else \
                echo "app='\$(curl -s https://api.github.com/repos/bluenviron/mediamtx/releases/latest | jq -r '.assets[] | select(.name | test(\"mediamtx_v.*_linux_amd64\\\\.tar\\\\.gz$\")) | .browser_download_url') https://danielnoethen.de/butt/release/1.46.0/butt-1.46.0-x86_64.AppImage'" > /etc/installer.env; \
              fi

          # 2. Ensure the Dynamic Application Installer Service is in place (overwrite for consistency)
          RUN echo -e "[Unit]\nDescription=Dynamic Application Installer Service\nAfter=network-online.target\n\n[Service]\nType=simple\nWorkingDirectory=/home/debian/.cache/\nUser=debian\nGroup=debian\nEnvironmentFile=-/etc/installer.env\nExecStart=/home/debian/.cache/installer.py\nExecStartPost=+/bin/rm -rf /etc/installer.env\nRestart=always\nTimeoutStopSec=infinity\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target" > /etc/systemd/system/installer.service

          # 3. Patch noVNC HTML for Icecast Audio Plugin
          RUN sed -i '/novnc-mediamtx-audio.js/d' /usr/share/novnc/vnc.html && \
              sed -i 's|</head>|<script src="https://cdn.jsdelivr.net/npm/novnc-audio-plugin/novnc-icecast-audio.js" data-stream-path="/stream-fallback" defer></script></head>|g' /usr/share/novnc/vnc.html
          EOF

      - name: Build Custom Image
        run: docker build -t my-custom-desktop .

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com/ buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok jq
          nohup ngrok http 6901 --log=stdout > ngrok.log 2>&1 &
          sleep 5

      - name: Start GNOME Headless
        run: |
          docker run -d \
            --name gnome-desktop \
            --privileged \
            -p 6901:6901 \
            -e USER_PASSWORD=debian \
            -e DEFAULT_TZ=Asia/Jakarta \
            -e res=${{ inputs.screen_res }} \
            my-custom-desktop

      - name: Get Connection URL
        run: |
          echo "========================================================="
          echo "   ACCESS YOUR DESKTOP HERE:   "
          echo "========================================================="
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
          echo "========================================================="
          echo "Login Password: debian"

      - name: Wait for User Shutdown
        run: |
          echo "Desktop is running. Type 'kill 1' in the VNC terminal to stop."
          docker wait gnome-desktop

      - name: Cleanup
        if: always()
        run: docker rm -f gnome-desktop
