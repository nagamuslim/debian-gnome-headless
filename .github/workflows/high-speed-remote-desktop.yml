name: High-Speed Remote Desktop

on:
  workflow_dispatch:
    inputs:
      screen_res:
        description: 'Screen Resolution'
        required: true
        default: '1280x720'
        type: choice
        options:
          - '1280x720'
          - '1920x1080'
          - '1600x900'
          - '1024x768'
      connection_mode:
        description: 'Connection Mode'
        required: true
        default: 'VNC (HTTP)'
        type: choice
        options:
          - 'VNC (HTTP)'
          - 'SSH (TCP)'

permissions:
  contents: write

jobs:
  run-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout debian-gnome-headless
        uses: actions/checkout@v4

      # Checkout the website repo to a specific folder
      - name: Checkout gh-pages-repo
        uses: actions/checkout@v4
        with:
          repository: nagamuslim/nagamuslim.github.io
          path: gh-pages-repo
          token: ${{ secrets.GH_PAGES_TOKEN }}

      - name: Prepare Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM nagamuslim/debian-gnome-headless:latest
          RUN sed -i 's|butt-1.45.0-x86_64.AppImage|butt-1.46.0-x86_64.AppImage|g' /etc/installer.env && \
              sed -i 's|/release/1.45.0/|/release/1.46.0/|g' /etc/installer.env
          RUN sed -i '/novnc-mediamtx-audio.js/d' /usr/share/novnc/vnc.html && sed -i 's|<\/head>|<script src="https://cdn.jsdelivr.net/npm/novnc-audio-plugin/novnc-icecast-audio.js" data-stream-path="/stream-fallback" defer></script><\/head>|g' /usr/share/novnc/vnc.html
          EOF

      - name: Build Custom Image
        run: docker build -t my-custom-desktop .

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com/ buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok jq
          
          if [[ "${{ github.event.inputs.connection_mode }}" == "SSH (TCP)" ]]; then
            nohup ngrok tcp 2022 --log=stdout > ngrok.log 2>&1 &
          else
            nohup ngrok http 6901 --log=stdout > ngrok.log 2>&1 &
          fi
          sleep 10

      - name: Start GNOME Headless
        run: |
          docker run -d \
            --name gnome-desktop \
            --privileged \
            -p 6901:6901 \
            -p 2022:22 \
            -e gnome-initial-setup=no \
            -e DEFAULT_TZ=Asia/Jakarta \
            -e res=${{ github.event.inputs.screen_res }} \
            my-custom-desktop

      - name: Get Connection URL
        id: get_url
        run: |
          PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          if [[ $PUBLIC_URL == tcp://* ]]; then
            FINAL_URL="$PUBLIC_URL"
          else
            FINAL_URL="$PUBLIC_URL"
          fi
          
          echo "url=$FINAL_URL" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # STEP 2: UPDATE HTML TO ONLINE STATE
      # ---------------------------------------------------------
      
      - name: Modify HTML File (Online)
        run: |
          TARGET_FILE="gh-pages-repo/project/desktop/index.html" 
          URL="${{ steps.get_url.outputs.url }}"
          DATE=$(date)
          
          # We use perl instead of sed because perl handles multi-line replacements much better.
          # -0777 reads the whole file at once.
          
          # 1. Update Status Text (Multiline Regex)
          perl -0777 -i -pe "s|<!-- MAGIC_STATUS_START -->.*?<!-- MAGIC_STATUS_END -->|<!-- MAGIC_STATUS_START -->\n<p class=\"text-xl font-bold text-green-500 animate-pulse\">ONLINE</p>\n<!-- MAGIC_STATUS_END -->|s" $TARGET_FILE
          
          # 2. Update Button Link (Multiline Regex)
          perl -0777 -i -pe "s|<!-- MAGIC_HREF_START -->.*?<!-- MAGIC_HREF_END -->|<!-- MAGIC_HREF_START -->\n<a href=\"$URL\" target=\"_blank\" class=\"w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200\">Connect via NoVNC</a>\n<!-- MAGIC_HREF_END -->|s" $TARGET_FILE
          
          # 3. Add a timestamp at the end to GUARANTEE a file change (fixing 'clean tree' error)
          # We remove the last line if it exists (previous timestamp) and append a new one
          sed -i '$d' $TARGET_FILE
          echo "<!-- UPDATED: $DATE -->" >> $TARGET_FILE

      - name: Push Online Status
        uses: EndBug/add-and-commit@v9
        with:
          cwd: './gh-pages-repo'
          add: 'project/desktop/index.html'
          message: 'Update desktop status: ONLINE'
          push: true

      - name: Wait for User Shutdown
        run: |
          echo "Container is running. Connect here: ${{ steps.get_url.outputs.url }}"
          docker wait gnome-desktop

      # ---------------------------------------------------------
      # STEP 3: RESET HTML TO OFFLINE STATE
      # ---------------------------------------------------------
      
      - name: Modify HTML File (Offline)
        if: always() 
        run: |
          TARGET_FILE="gh-pages-repo/project/desktop/index.html"
          
          # 1. Reset Status
          perl -0777 -i -pe "s|<!-- MAGIC_STATUS_START -->.*?<!-- MAGIC_STATUS_END -->|<!-- MAGIC_STATUS_START -->\n<p class=\"text-xl font-bold text-red-500\">OFFLINE</p>\n<!-- MAGIC_STATUS_END -->|s" $TARGET_FILE
          
          # 2. Reset Button
          perl -0777 -i -pe "s|<!-- MAGIC_HREF_START -->.*?<!-- MAGIC_HREF_END -->|<!-- MAGIC_HREF_START -->\n<a href=\"#\" target=\"_blank\" class=\"w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 cursor-not-allowed pointer-events-none transition-colors duration-200\">Connect via NoVNC</a>\n<!-- MAGIC_HREF_END -->|s" $TARGET_FILE

          # 3. Remove the timestamp line we added earlier so the file is clean
          sed -i '$d' $TARGET_FILE
          echo "</html>" >> $TARGET_FILE

      - name: Push Offline Status
        if: always()
        uses: EndBug/add-and-commit@v9
        with:
          cwd: './gh-pages-repo'
          add: 'project/desktop/index.html'
          message: 'Update desktop status: OFFLINE'
          push: true

      - name: Cleanup Container
        if: always()
        run: docker rm -f gnome-desktop
