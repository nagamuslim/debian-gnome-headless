name: High-Speed Remote Desktop

on:
  workflow_dispatch:
    inputs:
      screen_res:
        description: 'Screen Resolution'
        required: true
        default: '1280x720'
        type: choice
        options:
          - '1280x720'
          - '1920x1080'
          - '1600x900'
          - '1024x768'

jobs:
  run-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM nagamuslim/debian-gnome-headless:latest

          # 1. Update butt version to 1.46.0 in installer.env
          RUN sed -i 's|butt-1.45.0-x86_64.AppImage|butt-1.46.0-x86_64.AppImage|g' /etc/installer.env && \
              sed -i 's|/release/1.45.0/|/release/1.46.0/|g' /etc/installer.env

          # 2. Patch noVNC HTML for Icecast Audio Plugin
          RUN sed -i '/novnc-mediamtx-audio.js/d' /usr/share/novnc/vnc.html && \
              sed -i 's|<\/head>|<script src="https://cdn.jsdelivr.net/npm/novnc-audio-plugin/novnc-icecast-audio.js" data-stream-path="/stream-fallback" defer></script><\/head>|g' /usr/share/novnc/vnc.html

          # 3. Install TTYD (Web Terminal)
          # Download binary, make executable, and move to bin
          RUN curl -L https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64 -o /usr/local/bin/ttyd && \
              chmod +x /usr/local/bin/ttyd

          # 4. Create TTYD Service (Runs on port 7681)
          # We use -b /terminal so it knows it is running under a subpath
          # We use 'bash' as the shell
          RUN echo -e "\n[Unit]\nDescription=TTYD Web Terminal\nAfter=network.target\n\n[Service]\nExecStart=/usr/local/bin/ttyd -p 7681 -b /terminal -W bash\nRestart=always\nUser=debian\nGroup=debian\n\n[Install]\nWantedBy=multi-user.target" > /etc/systemd/system/ttyd.service && sed -i '/-e/d' /etc/systemd/system/ttyd.service && \
              systemctl enable ttyd.service

          # 5. Inject Nginx Config for /terminal
          # We add the location block for ttyd right before the /stream-fallback block or end of file
          RUN sed -i '$d' /etc/nginx/conf.d/default.conf && \
              echo '    location /terminal/ {' >> /etc/nginx/conf.d/default.conf && \
              echo '        proxy_pass http://127.0.0.1:7681;' >> /etc/nginx/conf.d/default.conf && \
              echo '        proxy_http_version 1.1;' >> /etc/nginx/conf.d/default.conf && \
              echo '        proxy_set_header Upgrade \$http_upgrade;' >> /etc/nginx/conf.d/default.conf && \
              echo '        proxy_set_header Connection "upgrade";' >> /etc/nginx/conf.d/default.conf && \
              echo '        proxy_set_header Host \$host;' >> /etc/nginx/conf.d/default.conf && \
              echo '        proxy_set_header X-Real-IP \$remote_addr;' >> /etc/nginx/conf.d/default.conf && \
              echo '    }' >> /etc/nginx/conf.d/default.conf && \
              echo '}' >> /etc/nginx/conf.d/default.conf
          EOF

      - name: Build Custom Image
        run: docker build -t my-custom-desktop .

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com/ buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok jq
          
          # HTTP Tunnel (Serves VNC on root, Terminal on /terminal)
          nohup ngrok http 6901 --log=stdout > ngrok.log 2>&1 &
          sleep 5

      - name: Start GNOME Headless
        run: |
          docker run -d \
            --name gnome-desktop \
            --privileged \
            -p 6901:6901 \
            -e USER_PASSWORD=debian \
            -e DEFAULT_TZ=Asia/Jakarta \
            -e res=${{ inputs.screen_res }} \
            my-custom-desktop \
            /lib/systemd/systemd # IMPORTANT: We explicitly call systemd to ensure services start

      - name: Get Connection URL
        run: |
          echo "========================================================="
          echo "   CONNECTION DETAILS   "
          echo "========================================================="
          URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "Desktop VNC:      $URL"
          echo "Web Terminal:     $URL/terminal/"
          echo "========================================================="
          echo "Login Password: debian"

      - name: Wait for User Shutdown
        run: |
          echo "Desktop is running. Type 'kill 1' in the terminal to stop."
          docker wait gnome-desktop

      - name: Cleanup
        if: always()
        run: docker rm -f gnome-desktop