name: High-Speed Remote Desktop

on:
  workflow_dispatch:
    inputs:
      screen_res:
        description: 'Screen Resolution'
        required: true
        default: '1280x720'
        type: choice
        options:
          - '1280x720'
          - '1920x1080'
          - '1600x900'
          - '1024x768'
      connection_mode:
        description: 'Connection Mode'
        required: true
        default: 'VNC (HTTP)'
        type: choice
        options:
          - 'VNC (HTTP)'
          - 'SSH (TCP)'

permissions:
  contents: write

jobs:
  run-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout debian-gnome-headless
        uses: actions/checkout@v4

      # Checkout the website repo to a specific folder
      - name: Checkout gh-pages-repo
        uses: actions/checkout@v4
        with:
          repository: nagamuslim/nagamuslim.github.io
          path: gh-pages-repo
          token: ${{ secrets.GH_PAGES_TOKEN }}

      - name: Prepare Dockerfile
        run: |
          cat <<'EOF' > Dockerfile
          FROM nagamuslim/debian-gnome-headless:latest
          RUN sed -i 's|butt-1.45.0-x86_64.AppImage|butt-1.46.0-x86_64.AppImage|g' /etc/installer.env && \
              sed -i 's|/release/1.45.0/|/release/1.46.0/|g' /etc/installer.env
          RUN sed -i '/novnc-mediamtx-audio.js/d' /usr/share/novnc/vnc.html && sed -i 's|<\/head>|<script src="https://cdn.jsdelivr.net/npm/novnc-audio-plugin/novnc-icecast-audio.js" data-stream-path="/stream-fallback" defer></script><\/head>|g' /usr/share/novnc/vnc.html
          # --- Create Standalone Tor Browser Patching Script ---
          RUN echo '#!/bin/bash' > /usr/local/bin/patch_tor_browser.sh && \
            echo 'TOR_BROWSER_DIR="/home/debian/.var/app/org.torproject.torbrowser-launcher/data/torbrowser/tbb/x86_64/tor-browser"' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'TORRC_FILE="$TOR_BROWSER_DIR/Browser/TorBrowser/Data/Tor/torrc"' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'LOG_FILE="/home/debian/tor_patch.log"' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'echo "--- Tor Browser Exit Node Configuration Script ---" > "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'echo "Script started at $(date)" >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'echo "Attempting to configure Tor Browser exit node..." >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '# Wait for Tor Browser installation directory to exist' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'while [ ! -d "$TOR_BROWSER_DIR" ]; do' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    echo "Waiting for Tor Browser directory: $TOR_BROWSER_DIR" >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    sleep 10' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'done' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'echo "Tor Browser directory found." "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '# Wait for torrc file to exist' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'while [ ! -f "$TORRC_FILE" ]; do' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    echo "Waiting for torrc file: $TORRC_FILE" >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    sleep 5' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'done' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'echo "Torrc file found." >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '# Append ExitNodes and StrictNodes if not already present' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'if ! grep -q "ExitNodes {id}" "$TORRC_FILE"; then' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    echo "Appending ExitNodes {id} to "$TORRC_FILE" >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    echo "ExitNodes {id}" >> "$TORRC_FILE"' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'fi' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'if ! grep -q "StrictNodes 1" "$TORRC_FILE"; then' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    echo "Appending StrictNodes 1 to "$TORRC_FILE" >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo '    echo "StrictNodes 1" >> "$TORRC_FILE"' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'fi' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'echo "Tor Browser exit node configuration applied." >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh && \
            echo 'echo "Script finished at $(date)" >> "$LOG_FILE" 2>&1' >> /usr/local/bin/patch_tor_browser.sh 
          RUN chmod +x /usr/local/bin/patch_tor_browser.sh && mv /usr/local/bin/patch_tor_browser.sh /usr/local/bin/patch_tor.sh
          # --- End Create Standalone Tor Browser Patching Script ---
          EOF

      - name: Build Custom Image
        run: docker build -t my-custom-desktop .

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com/ buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok jq
          
          if [[ "${{ github.event.inputs.connection_mode }}" == "SSH (TCP)" ]]; then
            nohup ngrok tcp 2022 --log=stdout > ngrok.log 2>&1 &
          else
            nohup ngrok http 6901 --log=stdout > ngrok.log 2>&1 &
          fi
          sleep 10

      - name: Start GNOME Headless
        run: |
          docker run -d \
            --name gnome-desktop \
            --privileged \
            -p 6901:6901 \
            -p 2022:22 \
            -e gnome-initial-setup=no \
            -e DEFAULT_TZ=Asia/Jakarta \
            -e res=${{ github.event.inputs.screen_res }} \
            my-custom-desktop

      - name: Get Connection URL
        id: get_url
        run: |
          PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          if [[ $PUBLIC_URL == tcp://* ]]; then
            # Parse SSH Details for AI friendliness
            CLEAN_URL=${PUBLIC_URL#tcp://}
            HOST=${CLEAN_URL%:*}
            PORT=${CLEAN_URL##*:}
            
            # Set Outputs
            echo "mode=SSH" >> $GITHUB_OUTPUT
            echo "host=$HOST" >> $GITHUB_OUTPUT
            echo "port=$PORT" >> $GITHUB_OUTPUT
            echo "full_url=$PUBLIC_URL" >> $GITHUB_OUTPUT
          else
            echo "mode=VNC" >> $GITHUB_OUTPUT
            echo "full_url=$PUBLIC_URL/vnc.html?password=debian&autoconnect=true" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # STEP 2: UPDATE HTML TO ONLINE STATE
      # ---------------------------------------------------------
      
      - name: Modify HTML File (Online)
        run: |
          TARGET_FILE="gh-pages-repo/project/desktop/index.html" 
          # Important: The link is at https://nagamuslim.github.io/project/desktop/
          MODE="${{ steps.get_url.outputs.mode }}"
          URL="${{ steps.get_url.outputs.full_url }}"
          DATE=$(date)
          
          # 1. Update Status to ONLINE
          perl -0777 -i -pe "s|<!-- MAGIC_STATUS_START -->.*?<!-- MAGIC_STATUS_END -->|<!-- MAGIC_STATUS_START -->\n<p class=\"text-xl font-bold text-green-500 animate-pulse\">ONLINE ($MODE)</p>\n<!-- MAGIC_STATUS_END -->|s" $TARGET_FILE
          
          if [[ "$MODE" == "SSH" ]]; then
            HOST="${{ steps.get_url.outputs.host }}"
            PORT="${{ steps.get_url.outputs.port }}"
            
            # Create AI-Friendly JSON Block
            AI_JSON="<!-- AI_DATA: { \"mode\": \"ssh\", \"host\": \"$HOST\", \"port\": \"$PORT\", \"user\": \"debian\", \"pass\": \"debian\", \"command\": \"ssh -p $PORT debian@$HOST\" } -->"
            
            # Create Human/AI Readable Code Block
            HTML_BLOCK="<div class=\"bg-gray-900 p-4 rounded text-left font-mono text-sm text-green-400 break-all select-all\">ssh -p $PORT debian@$HOST<br><span class=\"text-gray-500\"># Password: debian</span><br><span class=\"text-gray-600 text-xs select-all\"># Raw: $URL</span></div>$AI_JSON"
            
            perl -0777 -i -pe "s|<!-- MAGIC_HREF_START -->.*?<!-- MAGIC_HREF_END -->|<!-- MAGIC_HREF_START -->\n$HTML_BLOCK\n<!-- MAGIC_HREF_END -->|s" $TARGET_FILE
          
          else
            # VNC MODE (Standard Button)
            HTML_BLOCK="<a href=\"$URL\" target=\"_blank\" class=\"w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200\">Connect via NoVNC</a>"
            
            perl -0777 -i -pe "s|<!-- MAGIC_HREF_START -->.*?<!-- MAGIC_HREF_END -->|<!-- MAGIC_HREF_START -->\n$HTML_BLOCK\n<!-- MAGIC_HREF_END -->|s" $TARGET_FILE
          fi
          
          # Force git update with timestamp
          sed -i '$d' $TARGET_FILE
          echo "<!-- UPDATED: $DATE -->" >> $TARGET_FILE

      - name: Push Online Status
        uses: EndBug/add-and-commit@v9
        with:
          cwd: './gh-pages-repo'
          add: 'project/desktop/index.html'
          message: 'Update desktop status: ONLINE'
          push: true

      - name: Wait for User Shutdown
        run: |
          echo "Container is running. Connect here: ${{ steps.get_url.outputs.url }}"
          docker wait gnome-desktop

      # ---------------------------------------------------------
      # STEP 3: RESET HTML TO OFFLINE STATE
      # ---------------------------------------------------------
      
      - name: Modify HTML File (Offline)
        if: always() 
        run: |
          TARGET_FILE="gh-pages-repo/project/desktop/index.html"
          # Important: The link is at https://nagamuslim.github.io/project/desktop/
          
          # 1. Reset Status
          perl -0777 -i -pe "s|<!-- MAGIC_STATUS_START -->.*?<!-- MAGIC_STATUS_END -->|<!-- MAGIC_STATUS_START -->\n<p class=\"text-xl font-bold text-red-500\">OFFLINE</p>\n<!-- MAGIC_STATUS_END -->|s" $TARGET_FILE
          
          # 2. Reset Button
          perl -0777 -i -pe "s|<!-- MAGIC_HREF_START -->.*?<!-- MAGIC_HREF_END -->|<!-- MAGIC_HREF_START -->\n<a href=\"#\" target=\"_blank\" class=\"w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 cursor-not-allowed pointer-events-none transition-colors duration-200\">Connect via NoVNC</a>\n<!-- MAGIC_HREF_END -->|s" $TARGET_FILE

          # 3. Remove the timestamp line we added earlier so the file is clean
          sed -i '$d' $TARGET_FILE
          echo "</html>" >> $TARGET_FILE

      - name: Push Offline Status
        if: always()
        uses: EndBug/add-and-commit@v9
        with:
          cwd: './gh-pages-repo'
          add: 'project/desktop/index.html'
          message: 'Update desktop status: OFFLINE'
          push: true

      - name: Cleanup Container
        if: always()
        run: docker rm -f gnome-desktop
